<script>
  // ===== Helpers =====
  function asNumber(id) {
    const el = document.getElementById(id);
    if (!el) return 0;
    const v = (el.value || "").toString().replace(",", ".");
    return Number(v) || 0;
  }

  function pctToDec(pct) { return (pct || 0) / 100; }
  function clamp01(x) { return Math.max(0, Math.min(1, x)); }

  function formatBRL(n) {
    return (n || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  }

  // ===== Model =====
  function computeModel(params) {

    const base = Math.max(1, params.base);
    const exposure = clamp01(params.exposure);
    const paidShare = clamp01(params.paidShare);

    const cpl = Math.max(0, params.cpl);
    const fixed = Math.max(0, params.fixed);
    const fullTicket = Math.max(0, params.fullTicket);

    const pennyConv = clamp01(params.pennyConv);
    const split5 = clamp01(params.split5);
    const split17 = 1 - split5;

    const fullCtrl = clamp01(params.fullCtrl);
    const buyerUplift = Math.max(1, params.buyerUplift);
    const fullBuyer = clamp01(fullCtrl * buyerUplift);

    // ===== Estrutura Base =====
    const exposedBase = base * exposure;
    const nonExposedBase = base - exposedBase;

    // ===== Penny =====
    const buyersTotal = exposedBase * pennyConv;
    const buyers5 = buyersTotal * split5;
    const buyers17 = buyersTotal * split17;

    const revenuePenny = (buyers5 * 5) + (buyers17 * 17);
    const rplPenny = revenuePenny / base;

    const exposedNonBuyers = exposedBase - buyersTotal;

    // ===== Full =====
    const salesNonExposed = nonExposedBase * fullCtrl;
    const salesExposedNonBuyers = exposedNonBuyers * fullCtrl;
    const salesBuyers = buyersTotal * fullBuyer;

    const totalFullSales =
      salesNonExposed +
      salesExposedNonBuyers +
      salesBuyers;

    const revenueFull = totalFullSales * fullTicket;

    // ===== Separação Baseline vs Uplift =====
    const revenueFullControl =
      (
        salesNonExposed +
        salesExposedNonBuyers +
        (buyersTotal * fullCtrl)
      ) * fullTicket;

    const revenueFullUplift =
      (salesBuyers - (buyersTotal * fullCtrl)) * fullTicket;

    // ===== Receita Total =====
    const totalRevenue = revenuePenny + revenueFull;
    const rpl = totalRevenue / base;

    // ===== Baseline sem Penny =====
    const revenueCurrent = (base * fullCtrl) * fullTicket;
    const rplCurrent = revenueCurrent / base;

    const deltaRevenue = totalRevenue - revenueCurrent;
    const deltaPct = revenueCurrent > 0 ? (deltaRevenue / revenueCurrent) : 0;

    const deltaRPL = rpl - rplCurrent;

    const fixedPerLead = fixed / base;

    const avgCostPerLead = cpl * paidShare;
    const netCAC = avgCostPerLead - rplPenny;

    const cpaMaxProxy = rpl - fixedPerLead;
    const beLeads = rpl > 0 ? (fixed / rpl) : Infinity;

    return {
      base,
      exposure,
      exposedBase,
      nonExposedBase,
      paidShare,
      cpl,
      fixed,
      fullTicket,
      revenuePenny,
      revenueFull,
      revenueFullControl,
      revenueFullUplift,
      totalRevenue,
      rpl,
      rplCurrent,
      deltaRevenue,
      deltaPct,
      deltaRPL,
      rplPenny,
      netCAC,
      fixedPerLead,
      cpaMaxProxy,
      beLeads
    };
  }

  // ===== KPIs =====
  function upsertKpis(model) {

    const elTotal = document.getElementById('kpiTotalRevenue');
    const elTotalNote = document.getElementById('kpiTotalRevenueNote');

    const elRPL = document.getElementById('kpiRPL');
    const elRPLNote = document.getElementById('kpiRPLNote');

    const elNetCAC = document.getElementById('kpiNetCAC');
    const elNetCACNote = document.getElementById('kpiNetCACNote');

    const elInc = document.getElementById('kpiIncrement');
    const elIncNote = document.getElementById('kpiIncrementNote');

    const elCPAMax = document.getElementById('kpiCPAMax');
    const elCPAMaxNote = document.getElementById('kpiCPAMaxNote');

    // ===== Big Number =====
    if (elTotal) elTotal.textContent = formatBRL(model.totalRevenue);

    if (elTotalNote) {
      elTotalNote.innerHTML =
        `Penny (L1): ${formatBRL(model.revenuePenny)}<br>` +
        `Full real: ${formatBRL(model.revenueFullControl)} ` +
        `+ Uplift compradores: ${formatBRL(model.revenueFullUplift)}`;
    }

    // ===== RPL =====
    if (elRPL) elRPL.textContent = formatBRL(model.rpl);
    if (elRPLNote)
      elRPLNote.textContent =
        `RPL atual: ${formatBRL(model.rplCurrent)} • ΔRPL: ${formatBRL(model.deltaRPL)}`;

    // ===== CAC =====
    if (elNetCAC) elNetCAC.textContent = formatBRL(model.netCAC);
    if (elNetCACNote)
      elNetCACNote.textContent =
        `Custo médio/lead: ${formatBRL(model.cpl * model.paidShare)} • RPL Penny: ${formatBRL(model.rplPenny)}`;

    // ===== Incremento =====
    if (elInc) elInc.textContent = formatBRL(model.deltaRevenue);
    if (elIncNote)
      elIncNote.textContent =
        `Incremento = L1 (Penny) + L2 (Uplift) • ${(model.deltaPct * 100).toFixed(1)}% vs atual`;

    // ===== Teto =====
    if (elCPAMax) elCPAMax.textContent = formatBRL(model.cpaMaxProxy);
    if (elCPAMaxNote)
      elCPAMaxNote.textContent =
        `Custo fixo/lead: ${formatBRL(model.fixedPerLead)} • BE: ${Math.ceil(model.beLeads).toLocaleString('pt-BR')} leads`;
  }

  // ===== Params =====
  function getParamsFromInputs() {
    return {
      base: asNumber('inpBase'),
      exposure: pctToDec(asNumber('inpExposure')),
      paidShare: pctToDec(asNumber('inpPaidShare')),
      cpl: asNumber('inpCPL'),
      fixed: asNumber('inpFixed'),
      fullTicket: asNumber('inpFullTicket'),
      pennyConv: pctToDec(asNumber('inpPennyConv')),
      split5: pctToDec(asNumber('inpSplit5')),
      fullCtrl: pctToDec(asNumber('inpFullCtrl')),
      buyerUplift: asNumber('inpBuyerUplift')
    };
  }

  function refreshAll() {
    const params = getParamsFromInputs();
    const model = computeModel(params);
    upsertKpis(model);
  }

  function bindInputs() {
    const ids = [
      'inpBase','inpExposure','inpPaidShare','inpCPL','inpFixed',
      'inpFullTicket','inpPennyConv','inpSplit5',
      'inpFullCtrl','inpBuyerUplift'
    ];

    ids.forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener('input', refreshAll);
    });
  }

  bindInputs();
  refreshAll();
</script>
